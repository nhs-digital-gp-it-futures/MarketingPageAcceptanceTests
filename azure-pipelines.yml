# ASP.NET Core (.NET Framework)
# Build and test ASP.NET Core projects targeting the full .NET Framework.
# Add steps that publish symbols, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

trigger:
- development

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  BROWSER: chrome

jobs:
  - job : Setup
    steps:
      - bash: |
          echo "$(MPURL)"
          domain=`echo "$(MPURL)" | awk -F[/:] '{print $4}'`
          echo "$domain"
          if [[ "$(MPURL)" == *"-dev.buyingcatalogue.digital.nhs.uk"* ]]
          then
            curl -k -i $(MPURL) --fail --connect-timeout 30 --resolve $domain:443:51.11.46.27
          elif [[ "$(MPURL)" == *"private-test.buyingcatalogue.digital.nhs.uk"* ]]
          then
            curl -k -i $(MPURL) --fail --connect-timeout 30 --resolve $domain:443:51.132.54.44
          elif [[ "$(MPURL)" == *"public-test.buyingcatalogue.digital.nhs.uk"* ]]
          then
            curl -k -i $(MPURL) --fail --connect-timeout 30 --resolve $domain:443:51.132.53.156
          else
            curl -k -i $(MPURL) --fail --connect-timeout 30
          fi
        displayName: 'Check URL is reachable'    
    

  - job: SupplierAcceptanceTests
    dependsOn: Setup
    steps:
    - script: |
        domain=`echo "$(MPURL)" | awk -F[/:] '{print $4}'`        
        if [[ "$(MPURL)" == *"-dev.buyingcatalogue.digital.nhs.uk"* ]]
        then
          ip="51.11.46.27"
        elif [[ "$(MPURL)" == *"private-test.buyingcatalogue.digital.nhs.uk"* ]]
        then
          ip="51.132.54.44"
        elif [[ "$(MPURL)" == *"public-test.buyingcatalogue.digital.nhs.uk"* ]]
        then
          ip="51.132.53.156"
        fi
        if [[ -n "$ip" ]]
        then
          echo "$ip        $domain" | sudo tee -a /etc/hosts
          cat domain-template.yaml | sed -i "s/DOMAIN/$domain/g" | sed -i "s/IP/$ip/g" > domain.yaml
          cat domain.yaml
          cat /etc/hosts
        else
          touch domain.yaml
        fi
      displayName: 'Resolve domain'
    - task: UseDotNet@2
      displayName: 'Use DotNet Core 3.1.x'
      inputs:
        packageType: 'sdk'
        version: '3.1.101'
        includePreviewVersions: false
        installationPath: '$(Agent.ToolsDirectory)'

    - task: AzureKeyVault@1
      inputs:
        azureSubscription: 'NHSAPP-BuyingCatalogue (Non-Prod)'
        KeyVaultName: 'gpitfutures-dev-kv'
        SecretsFilter: "*"

    - task: A8515EC8-7254-4FFD-912C-86772E2B5962@3
      displayName: 'Replace tokens'
      inputs:
        targetFiles: '**/*.json'
        encoding: 'auto'
        writeBOM: true
        actionOnMissing: 'continue'
        keepToken: true
        tokenPrefix: '#{'
        tokenSuffix: '}#'
        emptyValue: 
    
    - task: Bash@3
      displayName: Selenium Grid Setup
      inputs:
        targetType: 'inline'
        script: |
          docker-compose stop &&
          docker-compose rm -f &&
          docker-compose up --scale chrome=4 --scale firefox=4  -d
    - task: DotNetCoreCLI@2
      displayName: "Run Supplier Acceptance Tests"
      inputs:
        command: 'test'
        projects: 'src/MarketingPageAcceptanceTests.SupplierTests/*csproj'
        arguments: '-v n'        

  - job: AuthorityAcceptanceTests
    dependsOn: Setup
    steps:
    - script: |
        pwd
        ls
        domain=`echo "$(MPURL)" | awk -F[/:] '{print $4}'`
        if [[ "$(MPURL)" == *"-dev.buyingcatalogue.digital.nhs.uk"* ]]
        then
          ip="51.11.46.27"
        elif [[ "$(MPURL)" == *"private-test.buyingcatalogue.digital.nhs.uk"* ]]
        then
          ip="51.132.54.44"
        elif [[ "$(MPURL)" == *"public-test.buyingcatalogue.digital.nhs.uk"* ]]
        then
          ip="51.132.53.156"
        fi
        if [[ -n "$ip" ]]
        then
          echo "$ip        $domain" | sudo tee -a /etc/hosts
          cat domain-template.yaml | sed -i "s/DOMAIN/$domain/g" | sed -i "s/IP/$ip/g" > domain.yaml
          cat domain.yaml
          cat /etc/hosts
        else
          touch domain.yaml
        fi
      displayName: 'Resolve domain'
    - task: UseDotNet@2
      displayName: 'Use DotNet Core 3.1.x'
      inputs:
        packageType: 'sdk'
        version: '3.1.101'
        includePreviewVersions: false
        installationPath: '$(Agent.ToolsDirectory)'

    - task: AzureKeyVault@1
      inputs:
        azureSubscription: 'NHSAPP-BuyingCatalogue (Non-Prod)'
        KeyVaultName: 'gpitfutures-dev-kv'
        SecretsFilter: "*"

    - task: A8515EC8-7254-4FFD-912C-86772E2B5962@3
      displayName: 'Replace tokens'
      inputs:
        targetFiles: '**/*.json'
        encoding: 'auto'
        writeBOM: true
        actionOnMissing: 'continue'
        keepToken: true
        tokenPrefix: '#{'
        tokenSuffix: '}#'
        emptyValue: 
    
    - task: Bash@3
      displayName: Selenium Grid Setup
      inputs:
        targetType: 'inline'
        script: |
          docker-compose stop &&
          docker-compose rm -f &&
          docker-compose up --scale chrome=4 --scale firefox=4  -d -f domain.yaml
    - task: DotNetCoreCLI@2
      displayName: "Run Authority Acceptance Tests"
      inputs:
        command: 'test'
        projects: 'src/MarketingPageAcceptanceTests.AuthorityTests/*csproj'
        arguments: '-v n'